
# 📘 コード差分比較アプリ 要件定義書

## 📝 1. 概要
このアプリケーションは、教師と複数の学生が同じ画面上でリアルタイムにコードの差分を確認できるWebサービスです。教師が入力または編集したコードが、各学生の画面にリアルタイムで表示され、学生は自分のコードを入力・貼り付けて、差分を確認できます。

---

## 🔧 2. 技術スタック
| 項目         | 技術 |
|--------------|------|
| フレームワーク | Next.js (App Router) |
| バックエンド   | Supabase (Database, Realtime, Auth) |
| 認証          | Clerk |
| 差分表示      | diff-match-patch または `diff2html`, `react-diff-viewer` |
| スタイリング  | Tailwind CSS または Shadcn UI |

---

## 👥 3. ユーザー種別と権限
| ユーザー | 説明 | 主な権限 |
|----------|------|----------|
| 教師     | コードを入力・編集し、学生に配信する | セッション作成、コード編集、学生の一覧確認 |
| 学生     | 教師のコードを閲覧し、自分のコードを入力 | 自分のコード入力・差分確認 |

---

## 🖥️ 4. 機能一覧

### 4.1 認証機能（Clerk）
- メール/パスワードまたはOAuthによるログイン
- ロールごとのアクセス制限（教師・学生）

### 4.2 セッション管理（Supabase）
- 教師が「授業セッション」を作成（`session_id`）
- 学生はURLまたはセッションコードで参加

### 4.3 コード管理（Supabase + Realtime）
- 教師のコードをリアルタイムで保存・配信（`teacher_code` テーブル）
- 学生が自分のコードを入力（`student_code` テーブル）
- WebSocketベースの同期

### 4.4 差分表示機能
- 左側：教師のコード（リアルタイム反映）
- 右側：学生のコード（自由入力）
- 差分は色分けされて表示（追加・削除・変更）

### 4.5 管理画面（教師用）
- 参加中の学生一覧
- 各学生のコード確認（任意）

### 4.6 ログと履歴
- 各学生の提出履歴ログ（timestamp付き）
- セッションごとのコード履歴保存

---

## 🗃️ 5. データベース構造（Supabase）

### users
| カラム名       | 型        | 説明            |
|----------------|-----------|-----------------|
| id             | UUID      | ClerkのUID      |
| name           | text      | ユーザー名      |
| role           | text      | "teacher" or "student" |

### sessions
| カラム名       | 型        | 説明            |
|----------------|-----------|-----------------|
| id             | UUID      | セッションID    |
| teacher_id     | UUID      | 教師のユーザーID |
| title          | text      | セッションタイトル |
| created_at     | timestamp | 作成日時        |

### teacher_code
| カラム名       | 型        | 説明            |
|----------------|-----------|-----------------|
| id             | UUID      | コードID        |
| session_id     | UUID      | セッションID    |
| content        | text      | 教師のコード     |
| updated_at     | timestamp | 更新日時        |

### student_code
| カラム名       | 型        | 説明            |
|----------------|-----------|-----------------|
| id             | UUID      | コードID        |
| session_id     | UUID      | セッションID    |
| student_id     | UUID      | 学生のユーザーID |
| content        | text      | 学生のコード     |
| updated_at     | timestamp | 更新日時        |

---

## 📱 6. 画面一覧（概要）

| 画面名           | 概要 |
|------------------|------|
| ログイン画面       | Clerk認証によるログイン |
| セッション一覧画面（教師） | 過去セッション一覧、新規作成 |
| セッション参加画面（学生） | セッションID入力 or リンク参加 |
| コード比較画面     | 左：教師のコード、右：自分のコード、中央に差分表示 |
| 管理画面（教師）   | 学生一覧とそれぞれのコード確認機能 |

---

## 🔒 7. セキュリティ
- Supabase Row Level Security（RLS）でアクセス制御：
  - 教師のコードはそのセッションに関係する学生のみ読み取り可能
  - 学生は自分のコードしか書き込み・読み取りできない
- Clerkのロールに基づいてアクセスガード設定（middleware.ts）

---

## 📈 8. 今後の拡張（将来的な機能）
- 自動コード評価（AIまたはLint）
- コメントやフィードバック機能
- ファイル添付によるコード提出
- PDF差分レポート出力機能
